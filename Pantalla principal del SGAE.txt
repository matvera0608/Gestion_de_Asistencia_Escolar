def pantalla_principal(ventana):

  # --- EJECUCIÃ“N DE LA VENTANA PRINCIPAL ---
  ventana = mi_ventana
  ventana.title("Sistema Gestor de Asistencia")
  ventana.geometry("1250x625")
  ventana.minsize(1250, 100)
  ventana.configure(bg=colores["rosado_claro"])
  ventana.iconbitmap(Ã­cono)
  ventana.attributes("-alpha", 1)

  #--- LISTBOX ---
  barraDesplazadora()
  
  ventana.bind_all("<Key>", mover_con_flechas)
    
  return ventana

  # --- INICIO DEL SISTEMA ---
interfaz = pantalla_principal(mi_ventana)
interfaz.mainloop()

#Lista de comodines para la bÃºsqueda:
# "%{}" -> empieza con
# "{}%" -> termina con
# "%" -> contiene
# "{}" -> exacto
# "%{}%" -> contiene (por defecto)


# ðŸ“œ Lista de valores de sticky:
# Valor   Significado
# "n"     Norte â†’ arriba
# "s"     Sur â†’ abajo
# "e"     Este â†’ derecha
# "w"     Oeste â†’ izquierda
# "ne"    Arriba a la derecha
# "nw"    Arriba a la izquierda
# "se"    Abajo a la derecha
# "sw"    Abajo a la izquierda
# "ns"    Se estira verticalmente
# "ew"    Se estira horizontalmente
# "nsew"  Se estira completamente (ocupa todo)** â¬…ï¸ mÃ¡s usado

def convertir_a_json_serializable(datos):

  datos_convertidos = {}
  for clave, valor in datos.items():
    if isinstance(valor, fecha):
      # Convierte date a string en formato DD/MM/YYYY
      datos_convertidos[clave] = valor.strftime("%d/%m/%Y")
    elif isinstance(valor, hora):
      # Convierte time a string en formato HH:MM
      datos_convertidos[clave] = valor.strftime("%H:%M")
    else:
      datos_convertidos[clave] = valor
  return datos_convertidos

def guardar_datos(nombre_de_la_tabla, cajasDeTexto, tablas_de_datos, campos_db, ventana):  
  
  if not hasattr(tablas_de_datos, "winfo_exists") or not tablas_de_datos.winfo_exists():
    return
  try:
    selecciÃ³nDatos = tablas_de_datos.selection()
    if not selecciÃ³nDatos:
      mostrar_aviso(ventana, "FALTA SELECCIONAR 1 FILA", colores["amarillo_alerta"])
      return False
    
    Ã­tem = selecciÃ³nDatos[0]
    if not all(entry.get().strip() for entry in cajasDeTexto[nombre_de_la_tabla]):
      mensajeTexto.showinfo("ATENCIÃ“N", "HAY QUE COMPLETAR TODOS LOS CAMPOS")
      return False
    
    datos = obtener_datos_de_Formulario(nombre_de_la_tabla, cajasDeTexto, campos_db)
    
    if not datos:
      print("NO HAY DATOS QUE GUARDAR")
      return False
    
    datos = convertir_datos(campos_db[nombre_de_la_tabla], cajasDeTexto[nombre_de_la_tabla])
    
    valores = list(datos.values())
    tablas_de_datos.item(Ã­tem, values=valores)
    
    
    if nombre_de_la_tabla not in datos_en_cache:
      datos_en_cache[nombre_de_la_tabla] = []
      
    for entry in cajasDeTexto[nombre_de_la_tabla]:
      entry.delete(0, tk.END)
    mostrar_aviso(ventana, "âœ… SE HA GUARDADO EXITOSAMENTE", colores["verde_Ã©xito"], 10)

    def almacenar_en_json():
      global datos_en_cache
      # Convertir objetos date/time a strings antes de guardar en JSON
      datos_serializable = convertir_a_json_serializable(datos)
      datos_en_cache[nombre_de_la_tabla].append(datos_serializable)
      
      if os.path.exists("datos_cache.json"):
        with open("datos_cache.json", "r", encoding="utf-8") as f:
          datos_en_cache = json.load(f)
      else:
        datos_en_cache = {}
        
      if nombre_de_la_tabla not in datos_en_cache:
        datos_en_cache[nombre_de_la_tabla] = []
        
      datos_en_cache[nombre_de_la_tabla].append(datos_serializable)
        
      with open("datos_cache.json", "w", encoding="utf-8") as f:
        json.dump(datos_en_cache, f, ensure_ascii=False, indent=2)
      return True
    
    almacenar_en_json()
    
  except Exception as e:
    print(f"HA OCURRIDO UN ERROR AL GUARDAR LOS DATOS: {str(e)}")
    return False


def guardar_snapshot(treeview):
  #Guardamos el contenido de los datos como la selecciÃ³n y la copia de datos de manera temporal#
  copia_de_datos = {
    "filas": [],
    "selecciÃ³n": treeview.selection()
  }
  
  for item in treeview.get_children():
    valor = treeview.item(item, "values")
    tags = treeview.item(item, "tags")
    fila = { "iid": item, "valores": valor, "tags": tags}
    copia_de_datos["filas"].append(fila)
    
  return copia_de_datos

def restaurar_snapshot(treeview, copia_de_datos):
  #Restauramos cuando se deshabilitan los botones#
  
  treeview.delete(*treeview.get_children()) #Esto hace que limpie visualmente
  
  for fila in copia_de_datos["filas"]:
    treeview.insert("", "end", iid=fila["iid"], values=fila["valores"], tags=fila["tags"]) #Mientras recorro los datos voy volviendo a insertar todo
    
  treeview.selection_set(copia_de_datos["selecciÃ³n"]) #Y Este lo restaura todo

def filtrar(tablas_de_datos, nombre_tabla, selecciÃ³nEncabezado):
  #En esta funciÃ³n voy a filtrar todos los datos de la treeview.
  if not hasattr(tablas_de_datos, "winfo_exists") or not tablas_de_datos.winfo_exists():
    return 
  
  with conectar_base_de_datos() as conexiÃ³n:
    cursor = conexiÃ³n.cursor()
  for item in tablas_de_datos.get_children():
    tablas_de_datos.delete(item)
  
  sql, parametros = consulta_semÃ¡ntica(consultas, nombre_tabla, selecciÃ³nEncabezado, "%{}%")
  cursor.execute(sql, parametros)
  registros_ocultos = cursor.fetchall()
  cursor.close()
  for Ã­ndice, fila in enumerate(registros_ocultos):
    if len(fila) > 1:
      valores_visibles = fila[1:]
      id_iid = fila[0]
    else:
      valores_visibles = fila
      id_iid = None

    tag = "par" if Ã­ndice % 2 == 0 else "impar"
    if id_iid is not None:
      tablas_de_datos.insert("", "end", iid=str(id_iid), values=valores_visibles, tags=(tag,))
    else:
      tablas_de_datos.insert("", "end", values=valores_visibles, tags=(tag,))
  desconectar_base_de_datos(conexiÃ³n)